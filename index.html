<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>memory-task-pilot</title>
<style>
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', 'Nanum Gothic', Dotum, Arial, sans-serif;
    overflow-x: hidden;
  }
  
  
  /* åŒæ„ä¹¦é¡µé¢ */
  #consent {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000;
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow-y: auto;
  }
  
  .consent-content {
    max-width: 800px;
    margin: 50px auto;
    padding: 30px;
    background: #222;
    border-radius: 10px;
    border: 1px solid #444;
  }
  
  /* è§†é¢‘æ’­æ”¾ç•Œé¢ */
  #videoContainer {
    display: none;
    width: 100vw;
    height: 100vh;
    flex-direction: column;
    align-items: center;     /* æ°´å¹³å±…ä¸­ */
    justify-content: center; /* å‚ç›´å±…ä¸­ */
    overflow: auto;          /* å¦‚æœå±å¹•å¤ªå°å¯ä»¥æ»šåŠ¨ */
    }
  
  #videoBox {
    width: auto;        /* è‡ªåŠ¨å®½åº¦ï¼Œé€‚åº”è§†é¢‘å°ºå¯¸ */
    height: auto;       /* è‡ªåŠ¨é«˜åº¦ï¼Œé€‚åº”è§†é¢‘å°ºå¯¸ */
    min-width: 1280px;  /* æœ€å°å®½åº¦ç¡®ä¿è§†é¢‘å®Œæ•´ */
    min-height: 720px;  /* æœ€å°é«˜åº¦ç¡®ä¿è§†é¢‘å®Œæ•´ */
    display: flex;
    align-items: center;
    justify-content: center;
    }
  
    video {
    width: 1280px;      /* å›ºå®šå®½åº¦ */
    height: 720px;      /* å›ºå®šé«˜åº¦ */
    pointer-events: none !important;
    user-select: none !important;
    }
  
  /* æç¤ºä¿¡æ¯ */
  #prompt {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 26px;
    text-align: center;
    line-height: 1.5;
    background: rgba(0, 0, 0, 0.8);
    padding: 30px;
    border-radius: 10px;
    display: none;
    z-index: 100;
  }
  
  #progressInfo {
    position: fixed;
    top: 20px;
    left: 20px;
    font-size: 18px;
  }
  
  /* ä¼‘æ¯å€’è®¡æ—¶ */
  #restTimer {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 32px;
    color: #4CAF50;
    display: none;
  }
  

  /* æµ‹è¯•é˜¶æ®µç•Œé¢ */
  #testContainer {
    display: none;
    width: 100vw;
    min-height: 100vh;
    padding: 40px 20px;
    box-sizing: border-box;
  }
  
  .question-container {
    max-width: 1200px;
    margin: 0 auto;
    display: none;
  }
  
  .question-text {
    font-size: 28px;
    text-align: center;
    margin-bottom: 40px;
    color: #fff;
  }
  
  /* Temporal Order é€‰é¡¹ï¼ˆä¸¤å¼ å›¾ç‰‡ï¼‰ */
  .temporal-options {
    display: flex;
    justify-content: center;
    gap: 100px;
    margin: 40px 0;
  }
  
  /* 3-AFC é€‰é¡¹ï¼ˆä¸‰å¼ å›¾ç‰‡ï¼‰ */
  .afc-options {
    display: flex;
    justify-content: center;
    gap: 60px;
    margin: 40px 0;
  }
  
  .option {
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
  }
  
  .option:hover {
    transform: scale(1.05);
  }
  
  .option.selected {
    outline: 5px solid #4CAF50;
    border-radius: 5px;
  }
  
  .option img {
    width: 400px;
    height: 225px;
    object-fit: cover;
    border-radius: 5px;
  }
  
  .option-label {
    font-size: 20px;
    margin-top: 10px;
    color: #ccc;
  }
  
  .confirm-btn {
    display: block;
    margin: 40px auto;
    padding: 15px 40px;
    font-size: 22px;
    background: #2196F3;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  
  .confirm-btn:disabled {
    background: #666;
    cursor: not-allowed;
  }
  
  /* è¿›åº¦æ¡ */
  .progress-bar {
    width: 80%;
    max-width: 800px;
    height: 10px;
    background: #333;
    border-radius: 5px;
    margin: 20px auto;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: #4CAF50;
    width: 0%;
    transition: width 0.3s;
  }
  
  .progress-text {
    text-align: center;
    font-size: 18px;
    margin-top: 10px;
    color: #ccc;
  }
  
  /* å®Œæˆé¡µé¢ */
  #completion {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: #000;
    z-index: 2000;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  
  .success-msg {
    color: #4CAF50;
    font-size: 24px;
    margin: 20px 0;
  }
  
  .wait-warning {
    color: #FF9800;
    font-size: 20px;
    margin-bottom: 20px;
  }
  
  /* è¾“å…¥æ¡†æ ·å¼ */
  .input-group {
    margin: 20px 0;
  }
  
  .input-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
  }
  
  .input-group input {
    padding: 10px;
    width: 100%;
    box-sizing: border-box;
    font-size: 16px;
  }
  
  /* æŒ‰é’®æ ·å¼ */
  button {
    padding: 12px 25px;
    font-size: 18px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  
  button:hover {
    background: #45a049;
  }
</style>
</head>
<body>

<!-- 1. åŒæ„ä¹¦é¡µé¢ -->
<div id="consent">
  <div class="consent-content">
    <h2>ì‹œê° ê¸°ì–µ ì‹¤í—˜</h2>
    <p>ì‹¤í—˜ì— ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!</p>
    
    <div style="background:#333;padding:15px;border-radius:5px;margin:20px 0;">
      <h3 style="margin-top:0;">ì‹¤í—˜ ì§„í–‰ ì ˆì°¨:</h3>
      <ol style="line-height: 1.6;">
        <li><strong>1ë‹¨ê³„: ë™ì˜ìƒ ì‹œì²­</strong>: 8ê°œì˜ ì§§ì€ ë™ì˜ìƒì„ ì‹œì²­í•©ë‹ˆë‹¤ (ê° ë™ì˜ìƒ ì•½ 3ë¶„)</li>
        <li><strong>2ë‹¨ê³„: ë¬¸ì œ í’€ì´</strong>: ë™ì˜ìƒ ë‚´ìš©ì— ê´€í•œ ê¸°ì–µë ¥ í…ŒìŠ¤íŠ¸ ë¬¸ì œë¥¼ í’‰ë‹ˆë‹¤</li>
      </ol>
      
      <h3>ì£¼ì˜ì‚¬í•­:</h3>
      <ul style="line-height: 1.6;">
        <li>ì¡°ìš©í•˜ê³  ë°©í•´ë°›ì§€ ì•ŠëŠ” í™˜ê²½ì—ì„œ ì‹¤í—˜ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”</li>
        <li>ì‹¤í—˜ì€ ì•½ 40-50ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤</li>
        <li>ì•ˆì •ì ì¸ ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ ì£¼ì„¸ìš”</li>
        <li>ì‹¤í—˜ ì¤‘ì—ëŠ” í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ë‹«ì§€ ë§ˆì„¸ìš”</li>
        <li>ë™ì˜ìƒ ë‚´ìš©ì— ì§‘ì¤‘í•´ì„œ ì‹œì²­í•´ ì£¼ì„¸ìš”</li>
      </ul>
    </div>
    
    <div class="input-group">
      <label for="participantName" style="color: #4CAF50;">ì°¸ê°€ì ì´ë¦„:</label>
      <input type="text" id="participantName" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”">
    </div>
    
    <div style="margin-top: 30px; text-align: center;">
      <button id="agreeBtn">ë™ì˜í•˜ê³  ì‹¤í—˜ ì‹œì‘</button>
    </div>
  </div>
</div>

<!-- 2. è§†é¢‘æ’­æ”¾é˜¶æ®µ -->
<div id="videoContainer">
  <div id="progressInfo">
    ì§„í–‰ë„: <span id="currentVideoNum">0</span>/8
  </div>
  
  <div id="videoBox">
    <video id="videoPlayer" controls></video>
  </div>
  
  <div id="restTimer"></div>
  
  <div id="prompt">ë¡œë”© ì¤‘...</div>
</div>

<!-- è¿‡æ¸¡é¡µé¢ -->
<div id="transitionPage" style="display: none;">
  <div style="text-align: center; padding: 50px;">
    <h2>ë™ì˜ìƒ ì‹œì²­ ë‹¨ê³„ ì™„ë£Œ</h2>
    <p style="font-size: 24px; margin: 30px 0;">ë‹¤ìŒì€ ê¸°ì–µë ¥ í…ŒìŠ¤íŠ¸ ë‹¨ê³„ì…ë‹ˆë‹¤</p>
    <p style="font-size: 20px; color: #FF9800;">ì¤€ë¹„ë˜ë©´ ì•„ë¬´ í‚¤ë‚˜ ëˆŒëŸ¬ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
    <p style="font-size: 16px; color: #ccc; margin-top: 30px;">
      í…ŒìŠ¤íŠ¸ëŠ” ë‘ ê°€ì§€ ìœ í˜•ì˜ ë¬¸ì œë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:<br>
      1. ì‹œê°„ ìˆœì„œ íŒë‹¨: ì–´ë–¤ ì¥ë©´ì´ ë¨¼ì € ë‚˜íƒ€ë‚¬ëŠ”ì§€ ì„ íƒ<br>
      2. ê°ê´€ì‹ ì„ íƒ: ë¬¸ì œ ì„¤ëª…ì— ë§ëŠ” ì •ë‹µ ì„ íƒ
    </p>
  </div>
</div>

<!-- 3. æµ‹è¯•é˜¶æ®µ -->
<div id="testContainer">
  <div class="progress-bar">
    <div class="progress-fill"></div>
  </div>
  <div class="progress-text">
    ë¬¸ì œ ì§„í–‰: <span id="currentQuestionNum">0</span>/<span id="totalQuestions">0</span>
  </div>
  
  <!-- Temporal Order é¢˜ç›® -->
  <div id="temporalQuestion" class="question-container">
    <div class="question-text">ì–´ë–¤ ì¥ë©´ì´ ë¨¼ì € ë‚˜íƒ€ë‚¬ìŠµë‹ˆê¹Œ?</div>
    <div class="temporal-options">
      <div class="option" data-value="A">
        <img id="temporalImgA" src="" alt="ì˜µì…˜ A">
        <div class="option-label"> </div>
      </div>
      <div class="option" data-value="B">
        <img id="temporalImgB" src="" alt="ì˜µì…˜ B">
        <div class="option-label"> </div>
      </div>
    </div>
    <button id="confirmTemporalBtn" class="confirm-btn" disabled>ì„ íƒ í™•ì¸</button>
  </div>
  
  <!-- 3-AFC é¢˜ç›® -->
  <div id="afcQuestion" class="question-container">
    <div class="question-text" id="afcQuestionText"></div>
    <div class="afc-options">
      <div class="option" data-value="A">
        <img id="afcImgA" src="" alt="é€‰é¡¹A">
        <div class="option-label"> </div>
      </div>
      <div class="option" data-value="B">
        <img id="afcImgB" src="" alt="é€‰é¡¹B">
        <div class="option-label"> </div>
      </div>
      <div class="option" data-value="C">
        <img id="afcImgC" src="" alt="é€‰é¡¹C">
        <div class="option-label"> </div>
      </div>
    </div>
    <button id="confirmAfcBtn" class="confirm-btn" disabled>ì„ íƒ í™•ì¸</button>
  </div>
</div>

<!-- 4. å®Œæˆé¡µé¢ -->
<div id="completion">
  <h2>ì‹¤í—˜ ì™„ë£Œ!</h2>
  <div id="waitMsg" class="wait-warning">
    ë°ì´í„°ë¥¼ ì œì¶œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë‹«ì§€ ë§ˆì„¸ìš”... <span id="countdown" style="font-size: 24px; color: white;">5</span>
  </div>
  <div id="finalMsg" class="success-msg" style="display: none;">
    âœ… ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!
  </div>
</div>


<!-- Netlify Form -->
<form id="netlify-data-form" style="display: none;" netlify netlify-honeypot="bot-field" name="memory-task-pilot">
  <input type="hidden" name="form-name" value="memory-task-pilot">
  
  <!-- åŸºç¡€å­—æ®µ -->
  <input type="hidden" name="participant_id">
  <input type="hidden" name="start_time">
  <input type="hidden" name="end_time">
  
  <!-- ä½ æ­£åœ¨ä½¿ç”¨çš„æ•°æ®å­—æ®µ -->
  <input type="hidden" name="experiment_setup">
  <input type="hidden" name="accuracy_stats">
  <input type="hidden" name="response_summary">
  <input type="hidden" name="complete_data">
  
  <!-- Honeypot -->
  <input type="text" name="bot-field" style="display: none;">
</form>

<!-- å¼•å…¥é…ç½®æ–‡ä»¶ -->
<script src="config.js"></script>

<script>
// ====== å…¨å±€å˜é‡ ======
let participantData = {};
let experimentData = {};
let responseData = [];
let currentTrialIndex = 0;
let currentQuestionIndex = 0;
let questionStartTime = 0;
let isUploading = false;

// ä»é…ç½®æ–‡ä»¶è·å–å¸¸é‡
const REST_DURATION = EXPERIMENT_CONFIG.restDuration || 10;
const STORAGE_KEY = EXPERIMENT_CONFIG.storageKey || 'visual_memory_exp_v1';

// ====== å·¥å…·å‡½æ•° ======
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function arraysEqual(a, b) {
  if (a.length !== b.length) return false;
  return a.every((val, index) => val.id === b[index].id);
}

// ====== éšæœºåŒ–ç®—æ³• ======
function generateRandomizedExperiment() {
  const videos = [...EXPERIMENT_CONFIG.videos];
  
  // 1. æ‰“ä¹±è§†é¢‘é¡ºåº
  shuffleArray(videos);
  
  // 2. åˆ†é…ç‰ˆæœ¬é¡ºåºï¼šå‰2ä¸ªå…ˆintactådisruptedï¼Œå2ä¸ªå…ˆdisruptedåintact
  const versionOrder = {};
  videos.forEach((video, index) => {
    versionOrder[video.id] = index < 2 ? ['intact', 'disrupted'] : ['disrupted', 'intact'];
  });
  
  // 3. ç”Ÿæˆç¬¬ä¸€æ¬¡è§‚çœ‹é¡ºåº
  const firstWatchOrder = shuffleArray([...videos]);
  
  // 4. ç”Ÿæˆç¬¬äºŒæ¬¡è§‚çœ‹é¡ºåºï¼ˆç¡®ä¿ä¸ç¬¬ä¸€æ¬¡ä¸åŒï¼‰
  let secondWatchOrder;
  do {
    secondWatchOrder = shuffleArray([...videos]);
  } while (arraysEqual(firstWatchOrder, secondWatchOrder));
  
  // 5. æ„å»ºå®Œæ•´çš„è¯•éªŒåºåˆ—
  const trials = [];
  
  // ç¬¬ä¸€æ¬¡è§‚çœ‹
  firstWatchOrder.forEach(video => {
    const version = versionOrder[video.id][0];
    trials.push({
      videoId: video.id,
      version: version,
      watchNumber: 1,
      path: version === 'intact' ? video.intactPath : video.disruptedPath,
      duration: EXPERIMENT_CONFIG.videoDuration || 180
    });
  });
  
  // ç¬¬äºŒæ¬¡è§‚çœ‹
  secondWatchOrder.forEach(video => {
    const version = versionOrder[video.id][1];
    trials.push({
      videoId: video.id,
      version: version,
      watchNumber: 2,
      path: version === 'intact' ? video.intactPath : video.disruptedPath,
      duration: EXPERIMENT_CONFIG.videoDuration || 180
    });
  });
  
  // 6. ç”Ÿæˆæµ‹è¯•é—®é¢˜åºåˆ—
  const questions = [];
  videos.forEach(video => {
    const videoConfig = EXPERIMENT_CONFIG.videos.find(v => v.id === video.id);
    
    // æ”¶é›†æ‰€æœ‰temporalé—®é¢˜ï¼ˆ6ä¸ªï¼‰ï¼Œéšæœºæ’åº
    const allTemporalQuestions = [];
    videoConfig.temporalCategories.forEach(category => {
      category.questions.forEach(question => {
        allTemporalQuestions.push({
          type: 'temporal',
          category: category.name,
          videoId: video.id,
          ...question
        });
      });
    });
    shuffleArray(allTemporalQuestions).forEach(q => questions.push(q));
    
    // ä¿æŒafcé—®é¢˜åŸæœ‰é¡ºåº
    videoConfig.afcQuestions.forEach(q => {  // ç›´æ¥forEachï¼Œä¸shuffle
    questions.push({
        type: 'afc',
        videoId: video.id,
        ...q
    });
    });
  });
  
  return {
    versionOrder,
    firstWatchOrder: firstWatchOrder.map(v => v.id),
    secondWatchOrder: secondWatchOrder.map(v => v.id),
    trials,
    questions,
    generatedAt: new Date().toISOString(),
    configVersion: EXPERIMENT_CONFIG.version || '1.0'
  };
}

// ====== æ•°æ®ç®¡ç† ======
function saveProgress() {
  const progress = {
    participantData,
    experimentData,
    responseData,
    currentTrialIndex,
    currentQuestionIndex,
    savedAt: new Date().toISOString()
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(progress));
}

function loadProgress() {
  const saved = localStorage.getItem(STORAGE_KEY);
  return saved ? JSON.parse(saved) : null;
}

function clearProgress() {
  localStorage.removeItem(STORAGE_KEY);
}

// ====== åŒæ„ä¹¦é¡µé¢ ======
document.getElementById('agreeBtn').addEventListener('click', function() {
  const participantId = document.getElementById('participantName').value.trim();
  
  if (!participantId) {
    alert('ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”');
    return;
  }
  
  participantData = {
    participantId: participantId,
    startTime: new Date().toISOString()
  };
  
  // ç”Ÿæˆå®éªŒæ•°æ®
  experimentData = generateRandomizedExperiment();
  
  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
  saveProgress();
  
  // éšè—åŒæ„ä¹¦ï¼Œå¼€å§‹å®éªŒ
  document.getElementById('consent').style.display = 'none';
  startVideoPhase();
});

// ====== è§†é¢‘æ’­æ”¾é˜¶æ®µ ======
function startVideoPhase() {
  document.getElementById('videoContainer').style.display = 'flex';
  playNextVideo();
}

function playNextVideo() {
  if (currentTrialIndex >= experimentData.trials.length) {
    endVideoPhase();
    return;
  }
  
  const trial = experimentData.trials[currentTrialIndex];
  
  // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯ï¼ˆåªæ˜¾ç¤ºè¿›åº¦ï¼Œä¸æ˜¾ç¤ºå†…å®¹ä¿¡æ¯ï¼‰
  document.getElementById('currentVideoNum').textContent = currentTrialIndex + 1;
  
  // è®¾ç½®è§†é¢‘æº
  const videoPlayer = document.getElementById('videoPlayer');
  videoPlayer.src = trial.path;
  videoPlayer.currentTime = 0;
  
  // æ˜¾ç¤ºæç¤º
  const prompt = document.getElementById('prompt');
  prompt.innerHTML = `${currentTrialIndex + 1}ë²ˆì§¸ ë™ì˜ìƒ<br>ì§‘ì¤‘í•´ì„œ ì‹œì²­í•´ ì£¼ì„¸ìš”<br>ì¤€ë¹„ë˜ë©´ ì•„ë¬´ í‚¤ë‚˜ ëˆ„ë¥´ì„¸ìš”`;
  prompt.style.display = 'block';
  videoPlayer.style.display = 'none';
  
  // ç­‰å¾…ç”¨æˆ·æŒ‰é”®å¼€å§‹
  const startHandler = () => {
    document.removeEventListener('keydown', startHandler);
    prompt.style.display = 'none';
    videoPlayer.style.display = 'block';
    
    // è®°å½•å¼€å§‹æ—¶é—´
    trial.startTime = new Date().toISOString();
    
    // æ’­æ”¾è§†é¢‘
    videoPlayer.play();
    
    // // 3åˆ†é’Ÿåè‡ªåŠ¨ç»“æŸ
    // setTimeout(() => {
    //   if (!videoPlayer.ended) {
    //     videoPlayer.pause();
    //     endCurrentVideo();
    //   }
    // }, trial.duration * 1000);
  };
  
  document.addEventListener('keydown', startHandler);
  
  // è§†é¢‘ç»“æŸäº‹ä»¶
  videoPlayer.onended = endCurrentVideo;
}

function endCurrentVideo() {
  const trial = experimentData.trials[currentTrialIndex];
  trial.endTime = new Date().toISOString();
  
  // ä¿å­˜è§‚çœ‹æ•°æ®
  responseData.push({
    type: 'video_watching',
    trialIndex: currentTrialIndex,
    videoId: trial.videoId,
    version: trial.version,
    watchNumber: trial.watchNumber,
    startTime: trial.startTime,
    endTime: trial.endTime
  });
  
  saveProgress();
  
  // åˆ¤æ–­æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªè§†é¢‘
  const isLastVideo = currentTrialIndex === experimentData.trials.length - 1;
  
  if (!isLastVideo) {
    // ä¸æ˜¯æœ€åä¸€ä¸ªè§†é¢‘ï¼šæ˜¾ç¤ºä¼‘æ¯å€’è®¡æ—¶
    showRestTimer();
  } else {
    // æ˜¯æœ€åä¸€ä¸ªè§†é¢‘ï¼šç›´æ¥è¿›å…¥æµ‹è¯•é˜¶æ®µ
    // æ³¨æ„ï¼šè¿™é‡Œä¸è¦å¢åŠ currentTrialIndexï¼Œå› ä¸ºå·²ç»åˆ°æœ«å°¾äº†
    endVideoPhase();
  }
}

function showRestTimer() {
  const restTimer = document.getElementById('restTimer');
  restTimer.style.display = 'block';
  
  let timeLeft = REST_DURATION;
  restTimer.textContent = `íœ´ì‹ ${timeLeft}ì´ˆ`;
//   restTimer.textContent = `ä¼‘æ¯ ${timeLeft} ç§’`;
  
  const timer = setInterval(() => {
    timeLeft--;
    restTimer.textContent = `íœ´ì‹ ${timeLeft}ì´ˆ`;
    // restTimer.textContent = `ä¼‘æ¯ ${timeLeft} ç§’`;
    
    if (timeLeft <= 0) {
      clearInterval(timer);
      restTimer.style.display = 'none';
      currentTrialIndex++;  // å¢åŠ è§†é¢‘ç´¢å¼•
      playNextVideo();
    }
  }, 1000); // 1000 --- test 300
}

function endVideoPhase() {
  // éšè—è§†é¢‘å®¹å™¨
  document.getElementById('videoContainer').style.display = 'none';
  
  // æ˜¾ç¤ºè¿‡æ¸¡é¡µé¢
  document.getElementById('transitionPage').style.display = 'block';
  
  // ç­‰å¾…ç”¨æˆ·æŒ‰é”®å¼€å§‹æµ‹è¯•
  const startTestHandler = (e) => {
    document.removeEventListener('keydown', startTestHandler);
    document.getElementById('transitionPage').style.display = 'none';
    startTestPhase();
  };
  
  document.addEventListener('keydown', startTestHandler);
}

// ====== æµ‹è¯•é˜¶æ®µ ======
function startTestPhase() {
  document.getElementById('testContainer').style.display = 'block';
  document.getElementById('totalQuestions').textContent = experimentData.questions.length;
  showNextQuestion();
}

function showNextQuestion() {
  if (currentQuestionIndex >= experimentData.questions.length) {
    endTestPhase();
    return;
  }
  
  const question = experimentData.questions[currentQuestionIndex];
  questionStartTime = Date.now();
  
  // æ›´æ–°è¿›åº¦æ˜¾ç¤º
  document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
  document.querySelector('.progress-fill').style.width = 
    `${((currentQuestionIndex + 1) / experimentData.questions.length) * 100}%`;
  
  // éšè—æ‰€æœ‰é—®é¢˜å®¹å™¨
  document.querySelectorAll('.question-container').forEach(el => {
    el.style.display = 'none';
  });
  
  // æ˜¾ç¤ºå¯¹åº”ç±»å‹çš„é—®é¢˜
  if (question.type === 'temporal') {
    showTemporalQuestion(question);
  } else {
    showAfcQuestion(question);
  }
}

function showTemporalQuestion(question) {
  const container = document.getElementById('temporalQuestion');
  const imgA = document.getElementById('temporalImgA');
  const imgB = document.getElementById('temporalImgB');
  
  // è®¾ç½®å›¾ç‰‡
  imgA.src = question.frameA;
  imgB.src = question.frameB;
  
  // é‡ç½®é€‰æ‹©çŠ¶æ€
  document.querySelectorAll('.option').forEach(opt => {
    opt.classList.remove('selected');
  });
  
  const confirmBtn = document.getElementById('confirmTemporalBtn');
  confirmBtn.disabled = true;
  
  // æ˜¾ç¤ºå®¹å™¨
  container.style.display = 'block';
  
  // è®¾ç½®äº‹ä»¶ç›‘å¬
  const options = document.querySelectorAll('#temporalQuestion .option');
  options.forEach(opt => {
    opt.onclick = function() {
      options.forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      confirmBtn.disabled = false;
    };
  });
  
  confirmBtn.onclick = function() {
    const selected = document.querySelector('#temporalQuestion .option.selected');
    if (selected) {
      recordResponse(question, selected.dataset.value);
    }
  };
}

function showAfcQuestion(question) {
  const container = document.getElementById('afcQuestion');
  const questionText = document.getElementById('afcQuestionText');
  const imgA = document.getElementById('afcImgA');
  const imgB = document.getElementById('afcImgB');
  const imgC = document.getElementById('afcImgC');
  
  // è®¾ç½®é—®é¢˜å’Œå›¾ç‰‡
  questionText.textContent = question.question;
  imgA.src = question.options[0].image;
  imgB.src = question.options[1].image;
  imgC.src = question.options[2].image;
  
  // é‡ç½®é€‰æ‹©çŠ¶æ€
  document.querySelectorAll('.option').forEach(opt => {
    opt.classList.remove('selected');
  });
  
  const confirmBtn = document.getElementById('confirmAfcBtn');
  confirmBtn.disabled = true;
  
  // æ˜¾ç¤ºå®¹å™¨
  container.style.display = 'block';
  
  // è®¾ç½®äº‹ä»¶ç›‘å¬
  const options = document.querySelectorAll('#afcQuestion .option');
  options.forEach(opt => {
    opt.onclick = function() {
      options.forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      confirmBtn.disabled = false;
    };
  });
  
  confirmBtn.onclick = function() {
    const selected = document.querySelector('#afcQuestion .option.selected');
    if (selected) {
      recordResponse(question, selected.dataset.value);
    }
  };
}

function recordResponse(question, selectedAnswer) {
  const reactionTime = Date.now() - questionStartTime;
  const isCorrect = selectedAnswer === question.correct;
  
  responseData.push({
    type: 'question_response',
    questionIndex: currentQuestionIndex,
    questionType: question.type,
    videoId: question.videoId,
    category: question.category || null,
    questionId: question.id,
    selectedAnswer,
    correctAnswer: question.correct,
    isCorrect,
    reactionTime,
    responseTime: new Date().toISOString()
  });
  
  saveProgress();
  currentQuestionIndex++;
  showNextQuestion();
}

function endTestPhase() {
  document.getElementById('testContainer').style.display = 'none';
  showCompletionPage();
}

function calculateAccuracyStats() {
  const stats = {
    overall: {
      total: 0,
      correct: 0,
      accuracy: 0
    },
    byTaskType: {
      temporal: {
        total: 0,
        correct: 0,
        accuracy: 0
      },
      afc: {
        total: 0,
        correct: 0,
        accuracy: 0
      }
    },
    byTemporalCategory: {
      "Boundary-Boundary": {
        total: 0,
        correct: 0,
        accuracy: 0
      },
      "Boundary-Within": {
        total: 0,
        correct: 0,
        accuracy: 0
      },
      "Within-Within": {
        total: 0,
        correct: 0,
        accuracy: 0
      }
    }
  };
  
  // éå†æ‰€æœ‰é—®é¢˜å“åº”
  responseData.forEach(response => {
    if (response.type === 'question_response') {
      // æ€»ä½“ç»Ÿè®¡
      stats.overall.total++;
      if (response.isCorrect) stats.overall.correct++;
      
      // æŒ‰ä»»åŠ¡ç±»å‹ç»Ÿè®¡
      if (response.questionType === 'temporal') {
        stats.byTaskType.temporal.total++;
        if (response.isCorrect) stats.byTaskType.temporal.correct++;
        
        // æŒ‰temporalç±»åˆ«ç»Ÿè®¡
        const category = response.category;
        if (category && stats.byTemporalCategory[category]) {
          stats.byTemporalCategory[category].total++;
          if (response.isCorrect) stats.byTemporalCategory[category].correct++;
        }
      } else if (response.questionType === 'afc') {
        stats.byTaskType.afc.total++;
        if (response.isCorrect) stats.byTaskType.afc.correct++;
      }
    }
  });
  
  // è®¡ç®—æ­£ç¡®ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
  stats.overall.accuracy = stats.overall.total > 0 ? 
    (stats.overall.correct / stats.overall.total * 100).toFixed(2) : 0;
  
  stats.byTaskType.temporal.accuracy = stats.byTaskType.temporal.total > 0 ? 
    (stats.byTaskType.temporal.correct / stats.byTaskType.temporal.total * 100).toFixed(2) : 0;
  
  stats.byTaskType.afc.accuracy = stats.byTaskType.afc.total > 0 ? 
    (stats.byTaskType.afc.correct / stats.byTaskType.afc.total * 100).toFixed(2) : 0;
  
  // è®¡ç®—æ¯ä¸ªtemporalç±»åˆ«çš„æ­£ç¡®ç‡
  Object.keys(stats.byTemporalCategory).forEach(category => {
    const catStats = stats.byTemporalCategory[category];
    catStats.accuracy = catStats.total > 0 ? 
      (catStats.correct / catStats.total * 100).toFixed(2) : 0;
  });
  
  return stats;
}



// ====== å®Œæˆé¡µé¢ ======
async function showCompletionPage() {
  document.getElementById('completion').style.display = 'flex';
  
  // ä¸Šä¼ æ•°æ®åˆ°Netlify
  const uploadSuccess = await uploadDataToNetlify();
  
  // æ˜¾ç¤ºå€’è®¡æ—¶
  let timeLeft = 5;
  const countdownEl = document.getElementById('countdown');
  const timer = setInterval(() => {
    timeLeft--;
    countdownEl.textContent = timeLeft;
    
    if (timeLeft <= 0) {
      clearInterval(timer);
      document.getElementById('waitMsg').style.display = 'none';
      document.getElementById('finalMsg').style.display = 'block';
    }
  }, 1000);
  
  // æ¸…ç†æœ¬åœ°å­˜å‚¨
  clearProgress();
}

// ====== Netlifyæ•°æ®ä¸Šä¼  ======
async function uploadDataToNetlify() {
  if (isUploading) return false;
  isUploading = true;
  
  try {
    // ========== 1. é‡ç»„æ•°æ® ==========
    const organizedData = {
      // åŸºç¡€ä¿¡æ¯
      participant: {
        id: participantData.participantId,
        startTime: participantData.startTime,
        endTime: new Date().toISOString()
      },
      
      // å®éªŒè®¾ç½®
      experiment: {
        totalVideos: 4,
        totalTrials: 8,
        versionOrder: experimentData.versionOrder,
        firstWatchOrder: experimentData.firstWatchOrder,
        secondWatchOrder: experimentData.secondWatchOrder,
        generatedAt: experimentData.generatedAt
      },
      
      // è§†é¢‘è§‚çœ‹è®°å½•ï¼ˆæŒ‰è§†é¢‘åˆ†ç»„ï¼‰
      videoWatching: {},
      
      // é—®é¢˜å“åº”ï¼ˆæŒ‰è§†é¢‘å’Œç±»å‹åˆ†ç»„ï¼‰
      responses: {},
      
      // æ­£ç¡®ç‡ç»Ÿè®¡
      accuracy: {
        overall: { total: 0, correct: 0, accuracy: 0 },
        byTask: {
          temporal: { total: 0, correct: 0, accuracy: 0 },
          afc: { total: 0, correct: 0, accuracy: 0 }
        },
        byTemporalCategory: {
          "Boundary-Boundary": { total: 0, correct: 0, accuracy: 0 },
          "Boundary-Within": { total: 0, correct: 0, accuracy: 0 },
          "Within-Within": { total: 0, correct: 0, accuracy: 0 }
        }
      }
    };
    
    // ========== 2. å¤„ç†è§†é¢‘è§‚çœ‹æ•°æ® ==========
    responseData
      .filter(r => r.type === 'video_watching')
      .forEach(record => {
        if (!organizedData.videoWatching[record.videoId]) {
          organizedData.videoWatching[record.videoId] = [];
        }
        organizedData.videoWatching[record.videoId].push({
          watch: record.watchNumber,
          version: record.version,
          start: record.startTime,
          end: record.endTime,
          duration: Math.round((new Date(record.endTime) - new Date(record.startTime)) / 1000)
        });
      });
    
    // ========== 3. å¤„ç†é—®é¢˜å“åº”æ•°æ®å¹¶è®¡ç®—ç»Ÿè®¡ ==========
    responseData
      .filter(r => r.type === 'question_response')
      .forEach(response => {
        const videoId = response.videoId;
        
        // åˆå§‹åŒ–è§†é¢‘æ•°æ®ç»“æ„
        if (!organizedData.responses[videoId]) {
          organizedData.responses[videoId] = {
            temporal: [],
            afc: []
          };
        }
        
        // åˆ›å»ºå“åº”è®°å½•
        const record = {
          qid: response.questionId,
          type: response.questionType,
          category: response.category,
          selected: response.selectedAnswer,
          correct: response.correctAnswer,
          isCorrect: response.isCorrect,
          rt: response.reactionTime,
          time: response.responseTime
        };
        
        // æŒ‰ç±»å‹æ·»åŠ åˆ°è§†é¢‘
        if (response.questionType === 'temporal') {
          organizedData.responses[videoId].temporal.push(record);
        } else {
          organizedData.responses[videoId].afc.push(record);
        }
        
        // ========== 4. è®¡ç®—ç»Ÿè®¡ ==========
        // æ€»ä½“ç»Ÿè®¡
        organizedData.accuracy.overall.total++;
        if (response.isCorrect) organizedData.accuracy.overall.correct++;
        
        // æŒ‰ä»»åŠ¡ç±»å‹ç»Ÿè®¡
        if (response.questionType === 'temporal') {
          organizedData.accuracy.byTask.temporal.total++;
          if (response.isCorrect) organizedData.accuracy.byTask.temporal.correct++;
          
          // æŒ‰temporalç±»åˆ«ç»Ÿè®¡
          if (response.category && organizedData.accuracy.byTemporalCategory[response.category]) {
            organizedData.accuracy.byTemporalCategory[response.category].total++;
            if (response.isCorrect) organizedData.accuracy.byTemporalCategory[response.category].correct++;
          }
        } else {
          organizedData.accuracy.byTask.afc.total++;
          if (response.isCorrect) organizedData.accuracy.byTask.afc.correct++;
        }
      });
    
    // ========== 5. è®¡ç®—æ­£ç¡®ç‡ç™¾åˆ†æ¯” ==========
    const calcPercent = (correct, total) => 
      total > 0 ? ((correct / total) * 100).toFixed(2) : "0.00";
    
    organizedData.accuracy.overall.accuracy = 
      calcPercent(organizedData.accuracy.overall.correct, organizedData.accuracy.overall.total);
    
    organizedData.accuracy.byTask.temporal.accuracy = 
      calcPercent(organizedData.accuracy.byTask.temporal.correct, organizedData.accuracy.byTask.temporal.total);
    
    organizedData.accuracy.byTask.afc.accuracy = 
      calcPercent(organizedData.accuracy.byTask.afc.correct, organizedData.accuracy.byTask.afc.total);
    
    // è®¡ç®—temporalå„å­ç±»åˆ«æ­£ç¡®ç‡
    Object.keys(organizedData.accuracy.byTemporalCategory).forEach(category => {
      const cat = organizedData.accuracy.byTemporalCategory[category];
      cat.accuracy = calcPercent(cat.correct, cat.total);
    });
    
    // ========== 6. å‡†å¤‡Netlifyè¡¨å•æ•°æ® ==========
    const formData = new FormData();
    formData.append('form-name', 'memory-task-pilot');
    
    // åˆ†å¼€å­—æ®µæäº¤ï¼Œä¾¿äºNetlifyåå°æŸ¥çœ‹
    formData.append('participant_id', participantData.participantId);
    formData.append('start_time', participantData.startTime);
    formData.append('end_time', new Date().toISOString());
    
    // å®éªŒè®¾ç½®ï¼ˆJSONæ ¼å¼ï¼‰
    formData.append('experiment_setup', JSON.stringify({
      videos: Object.keys(organizedData.videoWatching),
      versionOrder: organizedData.experiment.versionOrder,
      firstWatchOrder: organizedData.experiment.firstWatchOrder,
      secondWatchOrder: organizedData.experiment.secondWatchOrder
    }, null, 2));
    
    // æ­£ç¡®ç‡ç»Ÿè®¡ï¼ˆJSONæ ¼å¼ï¼Œæœ€é‡è¦ï¼‰
    formData.append('accuracy_stats', JSON.stringify(organizedData.accuracy, null, 2));
    
    // ç®€åŒ–çš„å“åº”æ‘˜è¦ï¼ˆJSONæ ¼å¼ï¼‰
    const responseSummary = {};
    Object.keys(organizedData.responses).forEach(videoId => {
      responseSummary[videoId] = {
        temporalQuestions: organizedData.responses[videoId].temporal.length,
        afcQuestions: organizedData.responses[videoId].afc.length,
        temporalCorrect: organizedData.responses[videoId].temporal.filter(q => q.isCorrect).length,
        afcCorrect: organizedData.responses[videoId].afc.filter(q => q.isCorrect).length
      };
    });
    formData.append('response_summary', JSON.stringify(responseSummary, null, 2));
    
    // å®Œæ•´æ•°æ®ï¼ˆå¤‡ä»½ç”¨ï¼‰
    formData.append('complete_data', JSON.stringify(organizedData, null, 2));
    
    // Honeypotå­—æ®µ
    formData.append('bot-field', '');
    
    // ========== 7. æ£€æŸ¥æ•°æ®å¤§å° ==========
    const dataSize = new Blob([JSON.stringify(organizedData)]).size / 1024;
    console.log(`æ•°æ®å¤§å°: ${dataSize.toFixed(2)} KB`);
    
    if (dataSize > 90) {
      console.warn('âš ï¸ æ•°æ®æ¥è¿‘Netlifyé™åˆ¶ï¼Œå·²ç®€åŒ–éƒ¨åˆ†å­—æ®µ');
    }
    
    // ========== 8. æäº¤åˆ°Netlify ==========
    const response = await fetch('/', {
      method: 'POST',
      body: formData
    });
    
    if (response.ok) {
      console.log('âœ… æ•°æ®æˆåŠŸæäº¤åˆ°Netlify');
      console.log('ğŸ“Š æ­£ç¡®ç‡ç»Ÿè®¡:', organizedData.accuracy);
      return true;
    } else {
      console.error('âŒ Netlifyæäº¤å¤±è´¥:', response.status);
      return false;
    }
  } catch (error) {
    console.error('âŒ ä¸Šä¼ æ•°æ®æ—¶å‡ºé”™:', error);
    return false;
  } finally {
    isUploading = false;
  }
}

// ====== é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¿›åº¦ ======
window.addEventListener('DOMContentLoaded', () => {
  // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½é…ç½®æ–‡ä»¶
  if (typeof EXPERIMENT_CONFIG === 'undefined') {
    alert('å®éªŒé…ç½®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
    return;
  }
  
  const savedProgress = loadProgress();
  
  if (savedProgress) {
    // è¯¢é—®æ˜¯å¦ç»§ç»­ä¹‹å‰çš„è¿›åº¦
    const shouldContinue = confirm('ì´ì „ì— ì§„í–‰í•˜ë˜ ì‹¤í—˜ì´ ìˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní™•ì¸: ì´ì–´ì„œ ì§„í–‰\nì·¨ì†Œ: ìƒˆë¡œ ì‹œì‘');
    // const shouldContinue = confirm('æ£€æµ‹åˆ°æœªå®Œæˆçš„å®éªŒï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ\nç‚¹å‡»"ç¡®å®š"ç»§ç»­ï¼Œç‚¹å‡»"å–æ¶ˆ"å¼€å§‹æ–°å®éªŒ');
    
    if (shouldContinue) {
      participantData = savedProgress.participantData;
      experimentData = savedProgress.experimentData;
      responseData = savedProgress.responseData;
      currentTrialIndex = savedProgress.currentTrialIndex;
      currentQuestionIndex = savedProgress.currentQuestionIndex;
      
      // é¢„å¡«å‚ä¸è€…ç¼–å·
      document.getElementById('participantName').value = participantData.participantId || '';
      
      // æ ¹æ®è¿›åº¦è·³è½¬åˆ°ç›¸åº”é˜¶æ®µ
      if (currentTrialIndex < experimentData.trials.length) {
        // è¿˜åœ¨è§†é¢‘é˜¶æ®µ
        document.getElementById('consent').style.display = 'none';
        startVideoPhase();
      } else if (currentQuestionIndex < experimentData.questions.length) {
        // åœ¨æµ‹è¯•é˜¶æ®µ
        document.getElementById('consent').style.display = 'none';
        document.getElementById('videoContainer').style.display = 'none';
        startTestPhase();
      }
    } else {
      clearProgress();
    }
  }
});
</script>
</body>
</html>